name: MLOps Full Pipeline

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  train-build-deploy:
    runs-on: self-hosted

    steps:
    ###################################
    # 1. Checkout Code
    ###################################
    - name: Checkout
      uses: actions/checkout@v4

    ###################################
    # 2. Install Python Dependencies
    ###################################
    # ðŸŸ© FIX: Cleans old venv to prevent conflicts
    - name: Install Python Packages
      run: |
        echo "Cleaning previous virtual environment..."
        rm -rf venv
        
        echo "Creating new virtual environment..."
        python3 -m venv venv
        
        echo "Installing dependencies..."
        venv/bin/pip install --upgrade pip
        venv/bin/pip install -r requirements.txt

    ###################################
    # 3. Train Model
    ###################################
    # ðŸŸ© FIX: Uses 'venv/bin/python3' instead of system 'python3'
    - name: Train Model
      run: |
        venv/bin/python3 train.py

    ###################################
    # 4. Upload Artifact To S3
    ###################################
    - name: Upload Model To S3
      run: |
        aws s3 cp model.pkl s3://health-trainmodel/artifacts/model.pkl
        aws s3 cp vectorizer.pkl s3://health-trainmodel/artifacts/vectorizer.pkl

    ###################################
    # 5. Login To ECR
    ###################################
    - name: Login ECR
      run: |
        aws ecr get-login-password --region ap-south-1 | docker login \
        --username AWS \
        --password-stdin 861550625988.dkr.ecr.ap-south-1.amazonaws.com

    ###################################
    # 6. Build Docker Image
    ###################################
    - name: Build Docker Image
      run: |
        docker build -t 861550625988.dkr.ecr.ap-south-1.amazonaws.com/mlhealth .

    ###################################
    # 7. Push Docker Image
    ###################################
    - name: Push To ECR
      run: |
        docker push 861550625988.dkr.ecr.ap-south-1.amazonaws.com/mlhealth

    ###################################
    # 8. Run Container Locally (Self Hosted EC2)
    ###################################
    # ðŸŸ© FIX: Stops/Removes old container to prevent naming conflict
    - name: Run Container
      run: |
      
        
        echo "Starting new container..."
        docker run -d -p 8000:8000 --name ml-health \
        861550625988.dkr.ecr.ap-south-1.amazonaws.com/mlhealth
